<html>
<head><TITLE></TITLE></head>
<style>
	BODY { background-color: black; color: lightgreen; font-family: sans-serif;}
</style>
<body>

[$ if $fdat{agent} $]
    [- process_entry() -]
[$ else $]
    [- entry_form() -]
[$ endif $]

    

<p>
return to <a href="[+ $fdat{game} +]/round_current.xml">main page</a>
</p>

</body>
</html>

[$ sub entry_form $]
<FORM>
<input type='hidden' name='game' value='[+ $fdat{game} +]' />
<table>
<TR><TD>player:</TD><TD><INPUT type="text" name="player"></TD>
<TD>password:</TD><TD><INPUT type="password" name="password"></TD>
<td><INPUT type="submit" value="upload"></td></TR>
<TR><TD valign='top'>agent:</TD><TD colspan="4"><textarea name="agent" cols="80" rows="40"></textarea></TD></TR>
</table>
</FORM>

[$ endsub $]

[$ sub process_entry $]
[! use XML::Simple; !]
[- 
    $fdat{game} or die "no game provided\n";
    $path = $epreq->component->cwd;
   $path .= '/'.$fdat{game}; 
-]
[- chdir $path or die -]
[-
	open CONF, "configuration.xml" or die $!;
	local $/ = undef;

	$conf = XMLin( <CONF> );
	close CONF;

	( $player ) = grep $_->{content} eq $fdat{player}, @{$conf->{player}};
-]

[$ if $player->{password} ne $fdat{password} $]
[- $req_rec->status( 401 ); -]
<p>player not recognized or password not valid</p>
[$ else $]
[-
my $existed;

$existed = 1 if -e "mobil/$fdat{player}";

my $fagent;
open $fagent, '>', "mobil/$fdat{player}" 
    or die $!;

print $fagent $fdat{agent};
close $fagent;
-]
[$ if -e "mobil/$fdat{player}" $]
<p>agent uploaded</p>
[$ if $existed $]
<p>An agent was already present and has been... removed.</p>
[$ endif $]
[$ else $]
<p>Agent couldn't be uploaded, looks like there is a problem. Please contact the Architect.</p>
[$ endif $]

[$ endif $]

[$ endsub $]
