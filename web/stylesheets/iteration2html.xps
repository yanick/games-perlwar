<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<%

$t->{title}{showtag} = 0;
$t->set( 'log' => {
    pre => '<div name="log" class="log">',
    post => "</div>\n",
} );
$t->set( 'entry' => {
    pre => '<div class="entry">',
    post => '</div>',
} );

%>
<html>
<head>
<title>
    perlwar - <%~ /perlwar/configuration/title %>
</title>

<link REL="icon" HREF="perlwar.ico" />
<link REL="SHORTCUT ICON" HREF="perlwar.ico" />
<script type="text/javascript" src="/perlwar/perlwar.js" >
</script>

<link rel="stylesheet" type="text/css" href="/perlwar/perlwar.css" />

</head>
<body>

<div style="background: url(/perlwar/line.png);" >
<h1>
    <%= apply_templates( '/perlwar/configuration/title' ) %>
</h1>
<img src="/perlwar/logo.png" alt="PerlWar" style="display: inline" />  
</div>

<div class="rightSide">

<div class="summary">
<div align="center">
    iteration <%= findvalue( '/perlwar/round/@number' ) || '0'  %>
</div>
<br/>
<%
	my %players;
	$players{''} = { color => 'lightgrey' };
	for( findnodes( '/perlwar/configuration/player' ) )
	{
		my $name = $_->findvalue('./text()');
		$players{ $name  } = { color => $_->getAttribute( 'color' ) };
		$players{ $name }{status} = $_->getAttribute( 'status' );
		$players{ $names }{score} = 0;
	}

	for( findnodes( '/perlwar/round/theArray/slot/owner' ) )
	{
		my $player = $_->findvalue( './text()' );
		$players{$player}{score}++;
	}

%>

<!-- TODO: add submission time information -->
<%
	
	my %subm;
	for( grep $_, keys %players )
	{
		my $t = -M "mobil/$_" or next;
		$subm{ $_ } = $^T - $t*24*60*60;	
	}
	my @order = sort { $subm{$a} <=> $subm{$b} } keys %subm;
	for( 1..@order )
	{
		my $x = $order[$_-1];
		$subm{$x} = "<sub><a title='".localtime($subm{$x})."'>$_</a></sub>";
	}
%>
<% for( sort { $players{$b}{score} <=> $players{$a}{score} } keys %players ) { 
	next unless $_;  %> <!--  remove the blank player    -->
	<div style="color: <%= $players{$_}{color} %>"
		<% if( $players{$_}{status} eq 'EOT' ) { %> 
			class="deadPlayer" 
		<% } %> 
	>
	<%= $_ %> <%= $subm{$_} %> <span class="score"><%= $players{$_}{score} || "0" %></span>
	</div>
<% } %>

</div>

<div class="gameLinks">
<a href="configuration.xml">war configuration</a>
<br/><br/>
<% 
    use Cwd;
    my $dir = (split '/' => getcwd )[-1];
%>
<a href="../upload.epl?game=<%= $dir %>">u/l agent</a>
<br/><br/>
<a href=".?passthru=1">raw xml</a>

<br/><br/>

<form name='history_form' onSubmit="resolve_iteration();return true;"
    action='.' >
<b>log</b><br/>
<div style="margin-left: 10px">

iteration <SELECT name="history_select">
<% for( reverse 0..findvalue( '/perlwar/configuration/currentIteration/text()' ) ) { %>
	<option value='<%= sprintf 'round_%05d.xml', $_ %>'><%= $_ %></option> 
<% } %>
</SELECT>&nbsp;
<input type="submit" value="access" />
</div>
</form>
<br/>
<br/>
<a href="http://babyl.dyndns.org/perlwar">what is perlwar?</a>


</div>

</div>

<div class="leftSide">
<div class="theArray" style="clear: both;">
<% 

my $fill = length findvalue( '/perlwar/configuration/theArraySize/text()' );

for( 0..findvalue( '/perlwar/configuration/theArraySize/text()' ) -1 ) { %>
<div name='slot' 
	class="slot" 
	style='background-color: <%= $players{ findvalue( "/perlwar/round/theArray/slot[\@id = $_]/owner/text()" ) }{color} %>'  
	onclick="showSlot(<%= $_ %>)">
<% 
    my $owner = findvalue( "/perlwar/round/theArray/slot[\@id = $_]/owner/text()" );
    my $facade = findvalue( "/perlwar/round/theArray/slot[\@id = $_]/facade/text()" );
    $facade_color = $players{ $facade }{ color };
    $has_facade = $facade and $facade ne $owner;
%>    
    <%# $owner.":".$facade.":".$has_facade.":".$facade_color %>
    <%= "<span style='background-color: $facade_color'>" x !!$has_facade  %>
    <%=  sprintf "%0${fill}d", $_ %>
    <%= '</span>' x !!$has_facade  %>
    
</div>
<% } %>

</div>
<div style="clear: both;height:10px"></div>
<input type="submit" value="show log" onclick="showLog()" />
<div class="console">

<%= apply_templates( '/perlwar/round/log' ) %>
<% 
    $t->set( 'slot' => {
        testcode => \&tc_slot,
    } ); 

    sub tc_slot {
        my( $n, $t ) = @_;
        my $id = $n->findvalue( '@id' );
        my $code = $n->findvalue( 'code/text()' );
        $t->set({ 
            pre => "<div class='slotCode' name='slotCode' id='code_$id'>$code</div>\n" });
        return DO_SELF_ONLY;
    }

%>

<%~ //slot %>

</div>

</div>

<!-- to force the browser to adjust the height of the window -->
<script type="text/javascript"> showLog(); </script>
</body>
</html>
